<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Sprint Sport</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Main CSS -->
    <link rel="stylesheet" href="/style.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body>

    <%- include('partials/header') %>

        <div class="container mt-5 mb-5" style="max-width: 600px;">
            <div class="card bg-dark text-white border-secondary">
                <div class="card-header bg-transparent border-secondary text-center">
                    <h3 class="mb-0">Secure Checkout</h3>
                </div>
                <div class="card-body p-4">
                    <div
                        class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
                        <h5 class="mb-0 text-muted">Total Amount</h5>
                        <h2 class="mb-0 text-primary">â‚¹<%= total %>
                        </h2>
                    </div>

                    <form id="checkout-form" class="needs-validation" novalidate>
                        <!-- Shipping Details -->
                        <h5 class="text-white mb-3">Shipping Details</h5>
                        <div class="mb-3">
                            <label class="form-label text-muted">Full Name</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary"
                                id="shipping-name" value="<%= user.name %>" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">Phone Number</label>
                            <input type="tel" class="form-control bg-dark text-white border-secondary"
                                id="shipping-phone" value="<%= user.phone_number %>" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">Address</label>
                            <textarea class="form-control bg-dark text-white border-secondary" id="shipping-address"
                                rows="2" required><%= user.address %></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">Pincode</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary"
                                id="shipping-pincode" required>
                        </div>

                        <!-- Payment Mode -->
                        <h5 class="text-white mb-3 mt-4">Payment Method</h5>
                        <div class="mb-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="paymentMode" id="mode-online"
                                    value="Online" checked>
                                <label class="form-check-label text-white" for="mode-online">
                                    <i class="fas fa-credit-card me-2 text-primary"></i>Online Payment
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMode" id="mode-cod"
                                    value="COD">
                                <label class="form-check-label text-white" for="mode-cod">
                                    <i class="fas fa-truck me-2 text-success"></i>Cash on Delivery
                                </label>
                            </div>
                        </div>

                        <!-- <div class="alert alert-info bg-transparent border-info text-info small" id="secure-msg">
                            <i class="fas fa-shield-alt me-2"></i> Payments are secured by Razorpay.
                        </div> -->

                        <button type="submit" id="pay-button" class="btn btn-primary w-100 py-3 fw-bold neon-btn">Place
                            Order</button>
                    </form>
                </div>
            </div>
        </div>

        <%- include('partials/footer') %>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const form = document.getElementById('checkout-form');
                    const payButton = document.getElementById('pay-button');
                    const secureMsg = document.getElementById('secure-msg');
                    const isSingleBuy = <%= isSingleBuy %>;
                    const singleProductId = "<%= singleProductId %>";
                    const amount = <%= total %>;

                    // Toggle secure msg based on payment mode
                    const modeRadios = document.getElementsByName('paymentMode');
                    modeRadios.forEach(radio => {
                        radio.addEventListener('change', function () {
                            if (this.value === 'COD') {
                                secureMsg.style.display = 'none';
                                payButton.innerText = "Confirm Order";
                            } else {
                                secureMsg.style.display = 'block';
                                payButton.innerText = "Pay Now";
                            }
                        });
                    });

                    form.onsubmit = async function (e) {
                        e.preventDefault();
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return;
                        }

                        const shippingDetails = {
                            name: document.getElementById('shipping-name').value,
                            phone: document.getElementById('shipping-phone').value,
                            address: document.getElementById('shipping-address').value,
                            pincode: document.getElementById('shipping-pincode').value
                        };
                        const paymentMode = document.querySelector('input[name="paymentMode"]:checked').value;

                        payButton.disabled = true;
                        payButton.innerText = "Processing...";

                        try {
                            if (paymentMode === 'COD') {
                                // --- COD Flow ---
                                const response = await fetch('/place-order-cod', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        isSingleBuy,
                                        singleProductId,
                                        shippingDetails
                                    })
                                });
                                const result = await response.json();

                                if (result.success) {
                                    alert("Order Placed Successfully!");
                                    window.location.href = result.redirect;
                                } else {
                                    throw new Error(result.message || "Failed to place order");
                                }

                            } else {
                                // --- Online Flow ---
                                // 1. Create Order
                                const response = await fetch('/create-order', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ amount: amount })
                                });
                                const order = await response.json();

                                if (order.error) throw new Error(order.error);

                                // 2. Open Razorpay Checkout
                                var options = {
                                    "key": "<%= key_id %>",
                                    "amount": order.amount,
                                    "currency": "INR",
                                    "name": "Sprint Sport",
                                    "description": "Sports Gear Purchase",
                                    "order_id": order.id,
                                    "handler": async function (response) {
                                        // 3. Verify Payment
                                        const verifyResponse = await fetch('/verify-payment', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                razorpay_order_id: response.razorpay_order_id,
                                                razorpay_payment_id: response.razorpay_payment_id,
                                                razorpay_signature: response.razorpay_signature,
                                                isSingleBuy: isSingleBuy,
                                                singleProductId: singleProductId,
                                                shippingDetails: shippingDetails // Pass shipping details
                                            })
                                        });
                                        const verifyResult = await verifyResponse.json();

                                        if (verifyResult.success) {
                                            window.location.href = verifyResult.redirect;
                                        } else {
                                            alert("Payment Verification Failed: " + verifyResult.message);
                                            payButton.disabled = false;
                                            payButton.innerText = "Pay Now";
                                        }
                                    },
                                    "prefill": {
                                        "name": shippingDetails.name,
                                        "email": "<%= user.email %>",
                                        "contact": shippingDetails.phone
                                    },
                                    "theme": { "color": "#3399cc" },
                                    "modal": {
                                        "ondismiss": function () {
                                            payButton.disabled = false;
                                            payButton.innerText = "Pay Now";
                                        }
                                    }
                                };
                                var rzp1 = new Razorpay(options);
                                rzp1.on('payment.failed', function (response) {
                                    alert("Payment Failed: " + response.error.description);
                                    payButton.disabled = false;
                                    payButton.innerText = "Pay Now";
                                });
                                rzp1.open();
                            }
                        } catch (err) {
                            console.error(err);
                            alert("Error: " + err.message);
                            payButton.disabled = false;
                            payButton.innerText = paymentMode === 'COD' ? "Confirm Order" : "Pay Now";
                        }
                    };
                });
            </script>
</body>

</html>